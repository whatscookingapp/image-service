name: Docker CD

on: [push]

jobs:
  # build:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v1
  #   - name: npm install and build webpack
  #     run: |
  #       npm install
  #       npm run build
  #   - uses: actions/upload-artifact@master
  #     with:
  #       name: webpack artifacts
  #       path: public/

  # test:
  #   runs-on: ubuntu-latest
  #   needs: build
  #   strategy:
  #     matrix:
  #       os: [ubuntu-lastest, windows-2016]
  #       node-version: [8.x, 10.x]

  #   steps:
  #   - uses: actions/checkout@v1
  #   - name: Use Node.js ${{ matrix.node-version }}
  #     uses: actions/setup-node@v1
  #     with:
  #       node-version: ${{ matrix.node-version }}
  #   - uses: actions/download-artifact@master
  #     with:
  #       name: webpack artifacts
  #       path: public
  #   - name: npm install, and test
  #     run: |
  #       npm install
  #       npm test
  #     env:
  #       CI: true
  resolve-packages:
    container:
      image: swift:5.2
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1
      - name: Resolve packages
        run: swift package resolve
      - uses: actions/upload-artifact@master
        with:
          name: SwiftPM artifacts
          path: .build/

  Build-and-Push-Docker-Image:
    runs-on: ubuntu-latest
    needs: resolve-packages
    name: Docker Build, Tag, Push

    steps:
    - name: Checkout
      uses: actions/checkout@v1
    - uses: actions/download-artifact@master
        with:
          name: SwiftPM artifacts
          path: .build/
    - name: Build, Tag, Push
      uses: mattdavis0351/actions/docker-gpr@v1
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        image-name: image-service